---
- name: set three-day connection timeout
  blockinfile:
    dest: /etc/mysql/mysql.conf.d/mysqld.cnf
    marker: "### {mark} ANSIBLE MANAGED BLOCK"
    insertafter: "skip-external-locking"
    content: |
      wait_timeout=259200
      interactive_timeout=259200
- name: restart mysql to update config
  service: name=mysql state=restarted
- name: upload csv files
  become_user: sigvisa
  unarchive:
    copy=yes
    dest=/home/sigvisa/
    src=/home/dmoore/sigvisa_csv.tgz
    creates=/home/sigvisa/sigvisa_csv
- name: upload db configuration
  become_user: sigvisa
  copy:
    src=db_setup_config
    dest=/home/sigvisa/db_setup_config
- name: upload isc_origin dump
  become_user: sigvisa
  copy:
    src=isc_origin.dump
    dest=/home/sigvisa/isc_origin.dump
- name: upload llnl_wfdisc dump
  become_user: sigvisa
  copy:
    src=llnl_wfdisc.dump
    dest=/home/sigvisa/llnl_wfdisc.dump
- name: set DB password
  mysql_user: login_user=root login_password=55rontob name=root password=55rontob check_implicit_admin=yes

# todo: on AWS ubuntu 16.04 it is still necessary to set the plugin mysql_native_password by running 
#   ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '55rontob';
# not adding this right now since it only needs to be done once, and it looks possible that future ansible versions
# will allow changing the plugin directly: https://github.com/ansible/ansible-modules-core/issues/3003

- name: add leb data to db
  become_user: sigvisa
  shell: /home/sigvisa/.virtualenvs/sigvisa/bin/python database/setup_db.py /home/sigvisa/db_setup_config >> /home/sigvisa/db_log 2> /home/sigvisa/db_log_errs
  environment: 
    SIGVISA_HOME: /home/sigvisa/python/sigvisa
  args:
    creates: /home/sigvisa/python/sigvisa/database/setup_db_custom.sql
    chdir: /home/sigvisa/python/sigvisa/
- name: import isc_origin table
  mysql_db: name=ctbt3mos state=import target=/home/sigvisa/isc_origin.dump login_user=root login_password=55rontob
- name: import llnl_wfdisc table
  mysql_db: name=ctbt3mos state=import target=/home/sigvisa/llnl_wfdisc.dump login_user=root login_password=55rontob

- name: migrate django db
  become_user: sigvisa
  shell: /home/sigvisa/python/sigvisa/web/migrate.sh 
- name: start web interface
  service: name=sigvisa_web state=started